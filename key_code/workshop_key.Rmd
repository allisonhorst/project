---
title: "Advanced Data Visualization in `ggplot2`"
subtitle: "Rice University Data Visualization Symposium (2021)"
output: 
  html_document:
    css: ../css/style.css
    theme: flatly
    toc: TRUE
    toc_float: TRUE
    number_sections: TRUE
  
---

**Allison Horst, PhD**

Assistant Teaching Professor, Bren School, UC Santa Barbara

Email: ahorst@ucsb.edu

Twitter: [\@allison_horst](https://twitter.com/allison_horst)

# Welcome

Welcome to the Advanced Data Visualization with `ggplot2` workshop! 

In this workshop, we’ll cover concepts and skills to create effective, elegant data visualizations with `ggplot2` in R. We will start by reviewing, then building on, ggplot basics to make highly customized figures (including with scales, guides, themes, direct labeling and highlighting) while reinforcing data visualization principles by carefully considering why we update (or don’t update) each graph component. Next, we will learn how to make several elegant and modern (but less commonly seen) graph types before putting them together into a compound figure using the `patchwork` package. To wrap up, we’ll construct a beautiful map in `ggplot` to reinforce how tools and concepts we’ve learned are transferable across different data and visualization types. 

Participants should be able to:

- Install and attach R packages
- Make basic `ggplot2` graphs in R
- Work comfortably in either R scripts of R Markdown (Allison will be in R Markdown)

## Workshop outline 

-  Conceptual hierarchy of data viz
- `ggplot2` basics review
    - Aesthetic mapping
    - Themes
    - Labels
    - Facets (& facet grids vs facet wraps)
    - Getting things in order (e.g. fct_reorder)
    - All the legends things everyone always forgets 
- Advanced customization in `ggplot2`
    - scales for...
        - Thoughtful tick marks
        - Deliberate limits
        - Better color schemes (+ `paletteer`!)
    - In the weeds of themes (gridlines, panel colors, margins, etc.)
    - Direct annotation (as an alternative to legends)
    - Repulsive labels (e.g. `ggrepel`)
    - Highlighting for clarity (e.g. with `gghighlight`)
- A few new graph types to consider
    - Marginal plot
    - Beeswarm plots
    - Stream plot
    - Heatmap
- Compound figures
    - `patchwork`
    - Inset plots
- A beautiful map in `ggplot2`


# Citations and data

## R packages

Thank you to developers, sharers, teachers, and the entire R community for building things and creating resources to help us all learn. I'd especially like to thank developers & maintainers for the following packages: 

- `tidyverse`: Wickham et al., (2019). Welcome to the tidyverse. Journal of
  Open Source Software, 4(43), 1686,
  https://doi.org/10.21105/joss.01686
- `ggplot2`: H. Wickham. ggplot2: Elegant Graphics for Data Analysis. Springer-Verlag New
  York, 2016.
- `ggrepel`: Kamil Slowikowski (2021). ggrepel: Automatically Position Non-Overlapping Text
  Labels with 'ggplot2'. R package version 0.9.1.
  https://github.com/slowkow/ggrepel
- `gghighlight`: Hiroaki Yutani (2020). gghighlight: Highlight Lines and Points in 'ggplot2'. R
  package version 0.3.1. https://github.com/yutannihilation/gghighlight/
- `R Markdown`: Yihui Xie and J.J. Allaire and Garrett Grolemund (2018). R Markdown: The
  Definitive Guide. Chapman and Hall/CRC. ISBN 9781138359338. URL
  https://bookdown.org/yihui/rmarkdown.
- `sf`: Pebesma, E., 2018. Simple Features for R: Standardized Support for Spatial Vector
  Data. The R Journal 10 (1), 439-446, https://doi.org/10.32614/RJ-2018-009
  
## Lizard size measurement data

Our data are from [Jornada Basin Long Term Ecological Research site](https://lter.jornada.nmsu.edu/) in New Mexico, part of the US Long Term Ecological Research (LTER) network: 

- Lightfoot, D. and W.G. Whitford. 2020. Lizard pitfall trap data from 11 NPP study locations at the Jornada Basin LTER site, 1989-2006 ver 37. Environmental Data Initiative. https://doi.org/10.6073/pasta/4a6e258fb49c31e222ecbbcfd128967f

From the data package: "This data package contains data on lizards sampled by pitfall traps located at 11 consumer plots at Jornada Basin LTER site from 1989-2006. The objective of this study is to observe how shifts in vegetation resulting from desertification processes in the Chihuahaun desert have changed the spatial and temporal availability of resources for consumers. Desertification changes in the Jornada Basin include changes from grass to shrub dominated communities and major soil changes. If grassland systems respond to rainfall without significant lags, but shrub systems do not, then consumer species should reflect these differences. In addition, shifts from grassland to shrubland results in greater structural heterogeneity of the habitats. We hypothesized that consumer populations, diversity, and densities of some consumers will be higher in grasslands than in shrublands and will be related to the NPP of the sites. Lizards were captured in pitfall traps at the 11 LTER II/III consumer plots (a subset of NPP plots) quarterly for 2 weeks per quarter. Variables measured include species, sex, recapture status, snout-vent length, total length, weight, and whether tail is broken or whole. This study is complete." 

There are 16 total variables in the `lizards.csv` data we'll read in. The ones we'll use in this workshop are: 

- `date`: data collection date
- `scientific_name`: lizard scientific name
- `common_name`: lizard common name
- `site`: research site code
- `sex`: lizard sex (m = male; f = female; j = juvenile)
- `sv_length`: snout-vent length (millimeters)
- `total_length`: body length (millimeters)
- `weight`: body weight (grams)
- `tail`: tail condition (b = broken; w = whole)

## Jornada vegetation spatial data

From [Jornada Basin LTER Spatial Data](https://lter.jornada.nmsu.edu/spatial-data/): Dominant Vegetation of the JER and CDRRC in 1998  (Download KMZ 3972 KB) Dominant and subdominant vegetation on the Jornada Experimental Range and Chihuahuan Desert Rangeland Research Center in 1998. Published in Gibbens, R. P., McNeely, R. P., Havstad, K. M., Beck, R. F., & Nolen, B. (2005). Vegetation changes in the Jornada Basin from 1858 to 1998. Journal of Arid Environments, 61(4), 651-668.  

# Set-up

## Get workshop materials

You can get the workshop materials in two ways:

1. Clone the workshop repo from GitHub to work locally
2. Create an RStudio Cloud account, and click [HERE](https://rstudio.cloud/project/2181259) to get to the project. Make sure you click on 'Make permanent copy' so your updates & notes will be stored.

## Create a new R Markdown document or R script

Allison will be working in R Markdown, but you can follow along in either an .Rmd or R script. 

## Attach R packages

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```

```{r}
# General use packages:
library(tidyverse)
library(here)
library(janitor)

# Specifically for plots:
library(patchwork)
library(ggrepel)
library(gghighlight)
library(paletteer)
library(ggExtra)
library(ggbeeswarm)

# Spatial data simplified:
library(sf)

```

## Read in the lizard data

```{r}
lizards <- read_csv(here("data_tidy", "lizards.csv"))
```


# `ggplot2` Basics Review

# Advanced `ggplot2` customization

# Explore some new graph types

## Marginal plots

```{r}
whiptails <- lizards %>% 
  filter(common_name == "western whiptail") %>% 
  drop_na(total_length, weight)

# An issue with rug plots: 
ggplot(data = whiptails, aes(x = total_length, y = weight)) +
  geom_point() +
  geom_rug()
```

```{r}
p <- ggplot(data = whiptails, aes(x = total_length, y = weight)) +
  geom_point(aes(color = sex), size = 2) +
  theme_minimal() +
  scale_color_manual(values = c("cyan4", "black", "goldenrod"),
                     name = "Sex:", 
                     labels = c("female", "juvenile", "male")
  ) +
  theme(legend.position = "bottom") + 
  labs(x = "Total length (mm)", 
       y = "Weight (grams)")

# Example 1: A histogram
# ggMarginal(p, type = "histogram", fill = "gray60", color = NA)

# Example 2: A boxplot, grouped by sex (as in the plot)
ggMarginal(p, type = "boxplot", groupColour = TRUE)
```

## A beeswarm plot with `ggbeeswarm`

```{r}
ggplot(data = whiptails, aes(x = sex, y = weight)) +
  geom_beeswarm() +
  geom_boxplot(fill = NA) +
  scale_x_discrete(labels = c("female","juvenile","male")) +
  theme_minimal()
```


## A heatmap with `geom_tile()`

Heatmaps are a great way to see trends across groups. Here, we'll create one to visualize lizard counts by species and site.

```{r}
# Get the counts: 
lizard_counts <- lizards %>% 
  mutate(date = lubridate::mdy(date)) %>% 
  count(year = lubridate::year(date), common_name) %>% 
  drop_na()

# Make a heatmap of counts:
ggplot(data = lizard_counts, aes(x = year, y = common_name)) +
  geom_tile(aes(fill = n), show.legend = FALSE) +
  geom_text(aes(label = n), color = "white", size = 3) +
  scale_fill_gradientn(colors = c("navy","red","orange")) +
  theme_minimal() +
  labs(x = "Year", y = "Lizard common name")
```

## A streamplot

# Make a map!

```{r}
jornada_veg <- read_sf(here("data_raw","spatial_vegetation","JER Vegetation 1998.kmz")) %>% dplyr::select(Name) %>% 
  clean_names()

# Initial exploratory plot (one plot per attribute)
# plot(jornada_veg)

# Remember, you can see the paletteer palettes with: 
# View(palettes_c_names)
# View(palettes_d_names)

ggplot() +
  geom_sf(data = jornada_veg, 
          aes(fill = name),
          color = NA) +
  theme_minimal() +
  scale_fill_paletteer_d(palette = "ggthemes::manyeys")
```

# Learn more

Here are some of my favorite resources for building advanced data visualization tools in `ggplot2`, learning about new types of graphs, and choosing an appropriate graph type: 

## `ggplot2` tutorials and examples

- [Cedric Scherer](https://twitter.com/CedScherer)'s ["A `ggplot2` tutorial for beautiful plotting in R"](https://www.cedricscherer.com/2019/08/05/a-ggplot2-tutorial-for-beautiful-plotting-in-r/#legends)
- More about [`scales`](https://scales.r-lib.org/)


## Data viz inspiration 

- [The R Graph Gallery](https://www.r-graph-gallery.com/) by [Yan Holtz]()
- [From Data to Viz](https://www.data-to-viz.com/) by [Yan Holtz](https://twitter.com/R_Graph_Gallery) and [Conor Healy](http://www.conor.fr/indexEN.html)
